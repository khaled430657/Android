name: Android Emulator with Ngrok TCP

on: 
  workflow_dispatch: # يسمح لك بتشغيل السكربت يدوياً من لسان Actions

jobs:
  run-emulator:
    runs-on: ubuntu-latest
    steps:
      # 1. تجهيز الكود
      - uses: actions/checkout@v4

      # 2. تجهيز الجافا
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. تثبيت Ngrok
      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      # 4. تشغيل المحاكي وفتح النفق
      - name: Run Android Emulator & Start Tunnel
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          ram-size: 2048M
          disk-size: 4096M
          script: |
            echo "--- 1. Authenticating Ngrok ---"
            # يتم جلب التوكن من الأسرار. إذا فشل هذا، تأكد من إضافة Secret
            ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
            
            echo "--- 2. Starting Ngrok TCP Tunnel ---"
            # تشغيل النفق وتوجيه السجلات لملف خارجي للفحص
            ngrok tcp 5555 --log=stdout > ngrok.log &
            
            echo "Waiting 5 seconds for tunnel to establish..."
            sleep 5
            
            echo "--- 3. Debugging Logs (Check here if it fails) ---"
            # طباعة السجلات لرؤية أي رسائل خطأ من Ngrok
            cat ngrok.log
            echo "--------------------------------------------------"
            
            echo "--- 4. Extracting Public URL ---"
            PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
            
            if [ "$PUBLIC_URL" == "null" ] || [ -z "$PUBLIC_URL" ]; then
              echo "❌ ERROR: Could not fetch Ngrok URL."
              echo "Please check the logs above. Likely causes:"
              echo "1. Invalid Token."
              echo "2. Unverified Account (Credit Card/Phone needed for TCP)."
            else
              echo "✅ CONNECTION SUCCESSFUL!"
              echo "========================================================"
              echo "Run this command on your PC to connect:"
              echo ""
              echo "adb connect $(echo $PUBLIC_URL | sed 's/tcp:\/\///')"
              echo ""
              echo "========================================================"
            fi
            
            # إبقاء الجلسة مفتوحة لمدة 20 دقيقة
            echo "Keeping session alive for 20 minutes..."
            sleep 1200

name: Android CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. تثبيت Ngrok
      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      - name: Run Android Emulator with Ngrok
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          # 2. هنا نضع أوامر Ngrok داخل نفس بيئة المحاكي
          script: |
            echo "Setting up Ngrok..."
            # استخدم Secrets بدلاً من وضع التوكن مباشرة
            ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
            
            # تشغيل النفق لمنفذ 5555 (ADB) في الخلفية
            ngrok tcp 5555 --log=stdout > ngrok.log &
            
            echo "Waiting for Ngrok tunnel..."
            sleep 5
            
            # طباعة رابط الاتصال (ستجده في Logs الخطوة)
            echo "=========================================="
            echo "YOUR NGROK URL IS:"
            curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
            echo "=========================================="
            
            echo "Android Emulator started successfully!"
            
            # إبقاء الجلسة مفتوحة لمدة معينة (مثلاً 10 دقائق) لتتمكن من الاتصال
            sleep 600 

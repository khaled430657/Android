name: Android on macOS
on: workflow_dispatch

jobs:
  run-android:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install QEMU & Ngrok
        run: |
          brew update
          brew install qemu wget
          # ØªØ«Ø¨ÙŠØª Ngrok
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip
          unzip ngrok-v3-stable-darwin-amd64.zip
          # ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
          ./ngrok config add-authtoken 34jXK13BZ5o7SH6Yu3NCwhQg8L4_5z9UjyKk1FzjWAXA2CmGF

      - name: Download Android
        run: |
          # ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ© ÙˆØ³Ø±ÙŠØ¹Ø©
          wget -O android.iso https://mirrors.gigenet.com/osdn/android-x86/69704/android-x86-8.1-r6.iso

      - name: Start Tunnel & Android
        run: |
          # ØªØ´ØºÙŠÙ„ Ngrok ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          ./ngrok tcp 5900 > /dev/null &
          sleep 5
          
          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          echo "=========================================="
          echo "ðŸ”´ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ VNC:"
          curl -s http://localhost:4040/api/tunnels | python3 -c "import sys, json; print(json.load(sys.stdin)['tunnels'][0]['public_url'].replace('tcp://', ''))"
          echo "=========================================="
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Ù…Ø¹ ØªØ³Ø±ÙŠØ¹ HVF Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø§Ùƒ)
          sudo qemu-system-x86_64 \
            -m 6096 \
            -smp 4 \
            -cdrom android.iso \
            -net nic -net user \
            -vnc :0 \
            -boot d \
            -accel hvf \
            -cpu host

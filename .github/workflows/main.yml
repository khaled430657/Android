name: Android Emulator Final

on: 
  workflow_dispatch: # تشغيل يدوي

jobs:
  run-emulator:
    runs-on: ubuntu-latest
    steps:
      # 1. تجهيز الكود
      - uses: actions/checkout@v4

      # 2. تجهيز الجافا
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. تثبيت Ngrok
      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      # 4. تشغيل المحاكي وفتح النفق
      - name: Run Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          ram-size: 2048M
          disk-size: 4096M
          script: |
            # 1. تفعيل التوكن (تأكد من وجوده في Secrets)
            ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
            
            # 2. تشغيل النفق في الخلفية وحفظ السجل
            echo "Starting Ngrok..."
            ngrok tcp 5555 --log=stdout > ngrok.log &
            
            # 3. انتظار 10 ثواني لضمان الاتصال
            sleep 10
            
            # 4. استخراج الرابط وطباعته بوضوح
            echo "========================================================"
            echo "✅ CONNECTION ESTABLISHED!"
            echo "Copy the address below (remove 'tcp://'):"
            echo ""
            grep -o "tcp://.*" ngrok.log
            echo ""
            echo "Example command: adb connect 0.tcp.ngrok.io:12345"
            echo "========================================================"
            
            # 5. إبقاء الجلسة مفتوحة لمدة 20 دقيقة
            echo "Session active. Connect now..."
            sleep 1200

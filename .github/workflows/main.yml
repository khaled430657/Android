name: Android VNC Stream

on: 
  workflow_dispatch:

jobs:
  vnc-android:
    runs-on: ubuntu-latest
    steps:
      # 1. تجهيز الكود
      - uses: actions/checkout@v4

      # 2. تثبيت واجهة سطح المكتب وسيرفر VNC (تستغرق دقيقة)
      - name: Install Desktop & VNC
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies tightvncserver expect

      # 3. تثبيت Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. تثبيت أدوات Android SDK يدوياً (لأننا نحتاج تحكماً كاملاً)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 5. تثبيت صورة المحاكي وإنشاء جهاز
      - name: Install Emulator & Create AVD
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-29" "emulator" "system-images;android-29;default;x86_64"
          echo "no" | avdmanager create avd -n test -k "system-images;android-29;default;x86_64" --force

      # 6. تثبيت Ngrok
      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      # 7. تشغيل كل شيء (VNC + Emulator + Ngrok)
      - name: Start System
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "--- 1. Setting VNC Password to '123456' ---"
          mkdir -p ~/.vnc
          # إعداد كلمة المرور تلقائياً
          echo "123456" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          echo "--- 2. Starting VNC Server on Display :1 ---"
          # تشغيل سيرفر الشاشة بأبعاد مناسبة للموبايل
          USER=runner vncserver :1 -geometry 1080x1920 -depth 24
          export DISPLAY=:1
          
          echo "--- 3. Starting Desktop Environment ---"
          startxfce4 &
          sleep 5

          echo "--- 4. Starting Android Emulator ---"
          # تشغيل المحاكي داخل شاشة VNC
          $ANDROID_HOME/emulator/emulator -avd test -no-audio -no-boot-anim -gpu swiftshader_indirect &

          echo "--- 5. Starting Ngrok Tunnel for VNC (Port 5901) ---"
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          # المنفذ 5901 هو المنفذ الخاص بالشاشة رقم 1
          ngrok tcp 5901 --log=stdout > ngrok.log &
          
          sleep 10
          
          echo "========================================================"
          echo "✅ READY TO CONNECT!"
          echo "1. Open VNC Viewer App."
          echo "2. Use this Address:"
          grep -o "tcp://.*" ngrok.log | sed 's/tcp:\/\///'
          echo "3. Password: 123456"
          echo "========================================================"
          
          # إبقاء الجلسة مفتوحة
          sleep 1800
